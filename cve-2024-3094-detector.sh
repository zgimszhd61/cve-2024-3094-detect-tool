#!/usr/bin/env bash

# 定义红色和绿色的终端输出颜色，以及无颜色（NC，No Color）
RED='\033[1;31m'
GREEN='\033[1;32m'
NC='\033[0m'

# 输出带有颜色的标题和作者信息
echo -e "${GREEN}
      _  _  _  _  _  _  _  _  _  _  _  _       _  _  _  _       _  _  _
     (_)(_)(_)(_)(_)(_)(_)(_)(_)(_)(_)(_) _  _(_)(_)(_)(_)_  _ (_)(_)(_) _
        (_)   (_)            (_)         (_)(_)          (_)(_)         (_)
        (_)   (_) _  _       (_) _  _  _ (_)(_)          (_)(_)    _  _  _
        (_)   (_)(_)(_)      (_)(_)(_)(_)   (_)          (_)(_)   (_)(_)(_)
 _      (_)   (_)            (_)   (_) _    (_)          (_)(_)         (_)
(_)  _  (_)   (_)            (_)      (_) _ (_)_  _  _  _(_)(_) _  _  _ (_)
 (_)(_)(_)    (_)            (_)         (_)  (_)(_)(_)(_)     (_)(_)(_)(_)

		CVE-2024-3094 detector
 ${NC}"

# 初始化变量，用于标记是否发现恶意xz版本
malicious_xz=1

# 1. 检查XZ版本
if [ -f /etc/alpine-release ]; then
	# 如果是在Alpine系统上运行，已知的易受攻击版本是：5.6.1-r0 和 5.6.1-r1
    xz_version=$(apk info --installed -v xz) 
    if [[ "$xz_version" =~ ^xz-5\.6\.1-r[0-1]$ ]]; then
        malicious_xz=0
    fi

else
    # 如果不是Alpine系统，检查xz版本是否 >= 5.5.0
    xz_version=$(strings "$(which xz)" | awk '/xz \(XZ Utils/ {print $4}')
    if awk -vv="$xz_version" 'BEGIN {split(v,a,"."); if (a[1]>=5 && a[2]>=5) exit 0; else exit 1}'; then
	malicious_xz=0
    fi
fi
    
# 2. 检查系统中是否存在sshd二进制文件
sshd_path=$(which sshd)
if [ -z "$sshd_path" ]; then
    sshd_found=1
else
    sshd_found=0
fi

# 3. 检查sshd是否使用了lzma
lzma_used=$(ldd "$sshd_path" 2>/dev/null | grep -q 'lzma'; echo $?)
if [ "$lzma_used" -eq 1 ]; then
    lzma_found=1
else
    lzma_path=$(ldd "$sshd_path" 2>/dev/null | grep 'lzma' | awk '{print $3}')
    lzma_found=0
fi

# 4. 检查lzma中是否存在特定的字节模式
if [ "$lzma_found" -eq 0 ]; then
    byte_pattern=$(hexdump -ve '1/1 "%.2x"' "$lzma_path" | grep -q 'f30f1efa554889f54c89ce5389fb81e7000000804883ec28488954241848894c2410'; echo $?)
    if [ "$byte_pattern" -eq 0 ]; then
        byte_pattern_found=0
    else
        byte_pattern_found=1
    fi
else
    byte_pattern_found=1
fi

# 输出检查结果
echo -ne "XZ易受攻击版本: "  
if [ "$malicious_xz" -eq 0 ]; then
    echo -e "${RED}是${NC} ($xz_version)"
else
    echo -e "${GREEN}否${NC} ($xz_version)"
fi

echo -ne "LZMA易受攻击版本: " 
if [ "$byte_pattern_found" -eq 0 ]; then
    echo -e "${RED}是${NC} (发现字节模式)"
else
    echo -e "${GREEN}否${NC}"
fi

echo -ne "系统中是否发现SSHD: "
if [ "$sshd_found" -eq 0 ]; then
    echo -e "${RED}是${NC} ($sshd_path)"
else
    echo -e "${GREEN}否${NC}"
fi

echo -ne "SSHD是否链接了LZMA: "
if [ "$lzma_found" -eq 0 ]; then
    echo -e "${RED}是${NC} ($lzma_path)"
else
    echo -e "${GREEN}否${NC}"
fi

# 输出结论
echo
if [ "$malicious_xz" -eq 0 ] || [ "$byte_pattern_found" -eq 0 ]; then
	echo -e "${RED}- 发现恶意XZ/LZMA: 是 ${NC}" 
    affected=0
else
	echo -e "${GREEN}- 发现恶意XZ/LZMA: 否 ${NC}"
	affected=1
fi

if [ "$lzma_used" -eq 0 ]; then
    echo -e "${RED}- 发现易受攻击的SSHD: 是 (SSHD链接了LZMA) ${NC}"
    vulnerable=0
else
    if [ "$sshd_found" -eq 1 ]; then
         echo -e "${GREEN}- 发现易受攻击的SSHD: 否 (未发现SSHD) ${NC}"
    else 
         echo -e "${GREEN}- 发现易受攻击的SSHD: 否 (SSHD未链接LZMA) ${NC}"
    fi
    vulnerable=1
fi

if [ "$vulnerable" -eq 0 ] && [ "$affected" -eq 0 ]; then
    echo -e "结论: ${RED}很可能易受CVE-2024-3094攻击 ${NC}"
else
    echo -e "结论: ${GREEN}不易受CVE-2024-3094攻击 ${NC}"
fi
echo